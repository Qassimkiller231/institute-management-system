# Attendance Management API Tests
# Base URL: http://localhost:3001

# ==================== VARIABLES ====================
# Replace these with actual values (tokens & IDs from DB)

@baseUrl = http://localhost:3001
@adminToken = your-admin-jwt-token-here
@teacherToken = your-teacher-jwt-token-here

# IDs - Replace with actual IDs from your DB
@studentId1 = student-id-1-here
@studentId2 = student-id-2-here
@studentId3 = student-id-3-here
@classSessionId = class-session-id-here
@groupId = group-id-here
@termId = term-id-here
@attendanceId = attendance-record-id-here

# ==================== AUTHENTICATION ====================
# First, get tokens from the auth module

### Request OTP (Teacher)
POST {{baseUrl}}/api/auth/request-otp
Content-Type: application/json

{
  "identifier": "teacher@institute.com",
  "method": "email"
}

### Verify OTP (Teacher)
POST {{baseUrl}}/api/auth/verify-otp
Content-Type: application/json

{
  "identifier": "teacher@institute.com",
  "code": "123456"
}

# Copy the token from response and update @teacherToken above

### Request OTP (Admin)
POST {{baseUrl}}/api/auth/request-otp
Content-Type: application/json

{
  "identifier": "admin@institute.com",
  "method": "email"
}

### Verify OTP (Admin)
POST {{baseUrl}}/api/auth/verify-otp
Content-Type: application/json

{
  "identifier": "admin@institute.com",
  "code": "123456"
}

# Copy the token from response and update @adminToken above

# ==================== 1. RECORD SINGLE ATTENDANCE ====================

### Record attendance - Present
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId1}}",
  "classSessionId": "{{classSessionId}}",
  "status": "PRESENT",
  "notes": "On time and engaged"
}

### Record attendance - Absent
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId2}}",
  "classSessionId": "{{classSessionId}}",
  "status": "ABSENT",
  "notes": "No notification received"
}

### Record attendance - Late
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId3}}",
  "classSessionId": "{{classSessionId}}",
  "status": "LATE",
  "notes": "Arrived 15 minutes late"
}

### Record attendance - Excused
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId1}}",
  "classSessionId": "{{classSessionId}}",
  "status": "EXCUSED",
  "notes": "Medical appointment with documentation"
}

# ==================== 2. BULK RECORD ATTENDANCE ====================

### Bulk record attendance for entire class
POST {{baseUrl}}/api/attendance/bulk
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "classSessionId": "{{classSessionId}}",
  "records": [
    {
      "studentId": "{{studentId1}}",
      "status": "PRESENT",
      "notes": "Participated actively"
    },
    {
      "studentId": "{{studentId2}}",
      "status": "PRESENT"
    },
    {
      "studentId": "{{studentId3}}",
      "status": "LATE",
      "notes": "Late by 10 minutes"
    }
  ]
}

# ==================== 3. GET STUDENT ATTENDANCE ====================

### Get all attendance for a student
GET {{baseUrl}}/api/attendance/student/{{studentId1}}
Authorization: Bearer {{teacherToken}}

### Get student attendance filtered by group
GET {{baseUrl}}/api/attendance/student/{{studentId1}}?groupId={{groupId}}
Authorization: Bearer {{teacherToken}}

### Get student attendance filtered by term
GET {{baseUrl}}/api/attendance/student/{{studentId1}}?termId={{termId}}
Authorization: Bearer {{teacherToken}}

### Get student attendance filtered by date range
GET {{baseUrl}}/api/attendance/student/{{studentId1}}?startDate=2024-01-01&endDate=2024-12-31
Authorization: Bearer {{teacherToken}}

### Get student attendance with multiple filters
GET {{baseUrl}}/api/attendance/student/{{studentId1}}?groupId={{groupId}}&startDate=2024-09-01&endDate=2024-12-31
Authorization: Bearer {{teacherToken}}

# ==================== 4. GET SESSION ATTENDANCE ====================

### Get all attendance for a class session
GET {{baseUrl}}/api/attendance/session/{{classSessionId}}
Authorization: Bearer {{teacherToken}}

# ==================== 5. GET ATTENDANCE STATISTICS ====================

### Get attendance stats for a student (all time)
GET {{baseUrl}}/api/attendance/student/{{studentId1}}/stats
Authorization: Bearer {{teacherToken}}

### Get attendance stats for a student in specific group
GET {{baseUrl}}/api/attendance/student/{{studentId1}}/stats?groupId={{groupId}}
Authorization: Bearer {{teacherToken}}

### Get attendance stats for a student in specific term
GET {{baseUrl}}/api/attendance/student/{{studentId1}}/stats?termId={{termId}}
Authorization: Bearer {{teacherToken}}

### Get attendance stats with date range
GET {{baseUrl}}/api/attendance/student/{{studentId1}}/stats?startDate=2024-09-01&endDate=2024-12-31
Authorization: Bearer {{teacherToken}}

# ==================== 6. GET LOW ATTENDANCE STUDENTS ====================

### Get students with attendance below 75% in a group
GET {{baseUrl}}/api/attendance/group/{{groupId}}/low-attendance
Authorization: Bearer {{teacherToken}}

### Get students with attendance below 80% (custom threshold)
GET {{baseUrl}}/api/attendance/group/{{groupId}}/low-attendance?threshold=80
Authorization: Bearer {{teacherToken}}

### Get students with attendance below 90%
GET {{baseUrl}}/api/attendance/group/{{groupId}}/low-attendance?threshold=90
Authorization: Bearer {{teacherToken}}

# ==================== 7. UPDATE ATTENDANCE ====================

### Update attendance status
PUT {{baseUrl}}/api/attendance/{{attendanceId}}
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "status": "PRESENT"
}

### Update attendance status and notes
PUT {{baseUrl}}/api/attendance/{{attendanceId}}
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "status": "EXCUSED",
  "notes": "Parent provided doctor's note after class"
}

### Update only notes
PUT {{baseUrl}}/api/attendance/{{attendanceId}}
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "notes": "Updated information received from parent"
}

# ==================== 8. DELETE ATTENDANCE ====================

### Delete attendance record
DELETE {{baseUrl}}/api/attendance/{{attendanceId}}
Authorization: Bearer {{teacherToken}}

# ==================== 9. ERROR CASES ====================

### Invalid status code
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId1}}",
  "classSessionId": "{{classSessionId}}",
  "status": "X"
}

### Missing required fields
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId1}}"
}

### Duplicate attendance record
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId1}}",
  "classSessionId": "{{classSessionId}}",
  "status": "PRESENT"
}

### Non-existent student
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "00000000-0000-0000-0000-000000000000",
  "classSessionId": "{{classSessionId}}",
  "status": "PRESENT"
}

### Non-existent class session
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "studentId": "{{studentId1}}",
  "classSessionId": "00000000-0000-0000-0000-000000000000",
  "status": "PRESENT"
}

### Invalid threshold (over 100)
GET {{baseUrl}}/api/attendance/group/{{groupId}}/low-attendance?threshold=150
Authorization: Bearer {{teacherToken}}

### Invalid threshold (negative)
GET {{baseUrl}}/api/attendance/group/{{groupId}}/low-attendance?threshold=-10
Authorization: Bearer {{teacherToken}}

# ==================== 10. ADMIN TESTS ====================

### Admin can record attendance
POST {{baseUrl}}/api/attendance
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "studentId": "{{studentId1}}",
  "classSessionId": "{{classSessionId}}",
  "status": "PRESENT",
  "teacherId": "teacher-id-here"
}

### Admin can view attendance
GET {{baseUrl}}/api/attendance/student/{{studentId1}}
Authorization: Bearer {{adminToken}}

### Admin can update attendance
PUT {{baseUrl}}/api/attendance/{{attendanceId}}
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "status": "EXCUSED",
  "notes": "Admin correction"
}

### Admin can delete attendance
DELETE {{baseUrl}}/api/attendance/{{attendanceId}}
Authorization: Bearer {{adminToken}}

# ==================== NOTES ====================
#
# Status codes:
# - PRESENT
# - ABSENT
# - LATE
# - EXCUSED
#
# Access Control:
# - Teachers: can record, view, and update attendance for their classes
# - Admins: full access
# - Students/Parents: no direct access (should be 403)
#
# Attendance rate (example):
#   (PRESENT + LATE) / Total Sessions * 100
#