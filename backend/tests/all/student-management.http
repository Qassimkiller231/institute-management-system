# Student Management API Tests
# Base URL: http://localhost:3001

# ==================== VARIABLES ====================
# Replace these with actual values from your database

@baseUrl = http://localhost:3001
@adminToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI0NjJjY2QzOS0xMzU5LTQ2MTYtODFjMi0zYzMxYTgxZDhjZTMiLCJlbWFpbCI6ImFkbWluQGluc3RpdHV0ZS5jb20iLCJyb2xlIjoiQURNSU4iLCJpYXQiOjE3NjMzNDU0ODcsImV4cCI6MTc2Mzk1MDI4N30._imZsnAjh6mOtksjPVFtlqCNJU3Gmec-suBv_6kc1Xk
@teacherToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI0YzYxNDhiNy05NTJhLTQ1ZWItYjA1NS0zMWQ5MjVlNDRkNjUiLCJlbWFpbCI6InNhcmFoLnRlYWNoZXJAaW5zdGl0dXRlLmNvbSIsInJvbGUiOiJURUFDSEVSIiwiaWF0IjoxNzYzMzkwODEzLCJleHAiOjE3NjM5OTU2MTN9.54muh3VK-Bf-3TUYbe7LIyOwqBQ4b-RUQCTLJ-GuPrc

# IDs - Replace with actual IDs
@studentId = b9314efd-8a0b-4a78-8a16-099cd6b4a6e9
@parentId = 8b22be73-37ab-4248-9668-7c3c0402c826
@phoneId = phone-id-here

# ==================== AUTHENTICATION ====================
# First, get an admin token from the auth module

### Request OTP (Admin)
POST {{baseUrl}}/api/auth/request-otp
Content-Type: application/json

{
  "identifier": "admin@institute.com",
  "method": "email"
}

### Verify OTP (Admin)
POST {{baseUrl}}/api/auth/verify-otp
Content-Type: application/json

{
  "identifier": "admin@institute.com",
  "code": "123456"
}

# Copy the token from response and update @adminToken above

# ==================== CREATE STUDENT ====================

### Create Student (Full Profile)
POST {{baseUrl}}/api/students
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "email": "ahmed.alisa@email.com",
  "phone": "+97333111242",
  "cpr": "044512345",
  "firstName": "Ahmed",
  "secondName": "Mohammed",
  "thirdName": "Ali",
  "dateOfBirth": "2005-04-15",
  "gender": "Male",
  "schoolType": "Government",
  "schoolYear": "Grade 10",
  "preferredTiming": "Evening",
  "preferredCenter": "Country Mall",
  "needsTransport": false,
  "area": "Hamad Town",
  "houseNo": "123",
  "road": "45",
  "block": "678",
  "healthIssues": "None",
  "howHeardAbout": "Facebook",
  "referralPerson": "Friend",
  "notes": "Very motivated student"
}

### Create Student (Minimal Profile)
POST {{baseUrl}}/api/students
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "cpr": "050623456",
  "firstName": "Fatima",
  "dateOfBirth": "2006-05-20",
  "gender": "Female"
}

### Create Student (With Shared Email - Parent Email)
POST {{baseUrl}}/api/students
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "email": "parent@email.com",
  "cpr": "070834567",
  "firstName": "Sara",
  "dateOfBirth": "2008-07-10",
  "gender": "Female",
  "notes": "Young student using parent's email"
}

### Create Student - Error: Missing Required Fields
POST {{baseUrl}}/api/students
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "firstName": "Test"
}

### Create Student - Error: Duplicate CPR
POST {{baseUrl}}/api/students
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "cpr": "040512345",
  "firstName": "Duplicate",
  "dateOfBirth": "2005-01-01",
  "gender": "Male"
}

# ==================== GET ALL STUDENTS ====================

### Get All Students (No Filters)
GET {{baseUrl}}/api/students
Authorization: Bearer {{adminToken}}

### Get All Students (With Pagination)
GET {{baseUrl}}/api/students?page=1&limit=10
Authorization: Bearer {{adminToken}}

### Get Active Students Only
GET {{baseUrl}}/api/students?isActive=true
Authorization: Bearer {{adminToken}}

### Get Students by Gender
GET {{baseUrl}}/api/students?gender=Male
Authorization: Bearer {{adminToken}}

### Get Students by School Type
GET {{baseUrl}}/api/students?schoolType=Government
Authorization: Bearer {{adminToken}}

### Get Students by School Year
GET {{baseUrl}}/api/students?schoolYear=Grade 10
Authorization: Bearer {{adminToken}}

### Get Students by Preferred Center
GET {{baseUrl}}/api/students?preferredCenter=Country Mall
Authorization: Bearer {{adminToken}}

### Get Students with Multiple Filters
GET {{baseUrl}}/api/students?isActive=true&gender=Female&preferredCenter=Riyadat Mall&page=1&limit=20
Authorization: Bearer {{adminToken}}

### Get Students with Search (Name)
GET {{baseUrl}}/api/students?search=Ahmed
Authorization: Bearer {{adminToken}}

### Get Students with Search (CPR)
GET {{baseUrl}}/api/students?search=0405
Authorization: Bearer {{adminToken}}

### Get Students with Search (Email)
GET {{baseUrl}}/api/students?search=ahmed.student@example.com
Authorization: Bearer {{adminToken}}

### Get All Students (Teacher Access)
GET {{baseUrl}}/api/students
Authorization: Bearer {{teacherToken}}

# ==================== GET STUDENT BY ID ====================

### Get Student by ID (Full Details)
GET {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{adminToken}}

### Get Student by ID (Teacher Access)
GET {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{teacherToken}}

### Get Student by ID - Error: Not Found
GET {{baseUrl}}/api/students/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{adminToken}}

# ==================== SEARCH STUDENTS ====================

### Search Students by Name
GET {{baseUrl}}/api/students/search?q=Ahmed
Authorization: Bearer {{adminToken}}

### Search Students by CPR
GET {{baseUrl}}/api/students/search?q=0405
Authorization: Bearer {{adminToken}}

### Search Students by Email
GET {{baseUrl}}/api/students/search?q=ahmed@email
Authorization: Bearer {{adminToken}}

### Search Students with Limit
GET {{baseUrl}}/api/students/search?q=a&limit=5
Authorization: Bearer {{adminToken}}

### Search Students - Error: No Query
GET {{baseUrl}}/api/students/search
Authorization: Bearer {{adminToken}}

# ==================== UPDATE STUDENT ====================

### Update Student (Partial Update)
PUT {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "schoolYear": "Grade 11",
  "preferredTiming": "Morning",
  "notes": "Updated to Grade 11"
}

### Update Student (Full Update)
PUT {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "firstName": "Ahmed",
  "secondName": "Mohammed",
  "thirdName": "Ali",
  "email": "ahmed.updated@email.com",
  "gender": "Male",
  "schoolType": "Private",
  "schoolYear": "Grade 11",
  "preferredTiming": "Morning",
  "preferredCenter": "Riyadat Mall",
  "needsTransport": true,
  "area": "Isa Town",
  "houseNo": "456",
  "road": "78",
  "block": "901",
  "healthIssues": "Asthma - mild",
  "howHeardAbout": "Instagram",
  "referralPerson": "Family member",
  "notes": "Fully updated profile"
}

### Update Student Email (To Shared Email)
PUT {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "email": "parent@email.com"
}

### Update Student - Deactivate
PUT {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "isActive": false
}

### Update Student - Reactivate
PUT {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "isActive": true
}

### Update Student - Error: Not Found
PUT {{baseUrl}}/api/students/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "notes": "This will fail"
}

# ==================== ADD PHONE NUMBER ====================

### Add Primary Phone to Student // in phone module
POST {{baseUrl}}/api/students/{{studentId}}/phones
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "phoneNumber": "+97333444655",
  "countryCode": "+973",
  "isPrimary": true
}

### Add Secondary Phone to Student
POST {{baseUrl}}/api/students/{{studentId}}/phones
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "phoneNumber": "+97333666777",
  "countryCode": "+973",
  "isPrimary": false
}

### Add Phone - Error: Missing Phone Number
POST {{baseUrl}}/api/students/{{studentId}}/phones
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "isPrimary": true
}

### Add Phone - Error: Duplicate Phone Number
POST {{baseUrl}}/api/students/{{studentId}}/phones
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "phoneNumber": "+97333444555",
  "isPrimary": false
}

# ==================== LINK PARENT ====================

### Link Parent to Student (With Relationship)
POST {{baseUrl}}/api/students/{{studentId}}/parents
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "parentId": "{{parentId}}",
  "relationship": "Father"
}

### Link Parent to Student (Without Relationship)
POST {{baseUrl}}/api/students/{{studentId}}/parents
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "parentId": "{{parentId}}"
}

### Link Parent - Error: Missing Parent ID
POST {{baseUrl}}/api/students/{{studentId}}/parents
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "relationship": "Mother"
}

### Link Parent - Error: Parent Not Found
POST {{baseUrl}}/api/students/{{studentId}}/parents
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "parentId": "00000000-0000-0000-0000-000000000000",
  "relationship": "Father"
}

### Link Parent - Error: Already Linked
POST {{baseUrl}}/api/students/{{studentId}}/parents
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "parentId": "{{parentId}}",
  "relationship": "Father"
}

# ==================== DELETE STUDENT ====================

### Delete Student (Soft Delete)
DELETE {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{adminToken}}

### Delete Student - Error: Not Found
DELETE {{baseUrl}}/api/students/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{adminToken}}

# ==================== AUTHORIZATION TESTS ====================

### Create Student - Error: Teacher Access Denied
POST {{baseUrl}}/api/students
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "cpr": "111122223333",
  "firstName": "Test",
  "dateOfBirth": "2010-01-01",
  "gender": "Male"
}

### Update Student - Error: Teacher Access Denied
PUT {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{teacherToken}}
Content-Type: application/json

{
  "notes": "Teacher cannot update"
}

### Delete Student - Error: Teacher Access Denied
DELETE {{baseUrl}}/api/students/{{studentId}}
Authorization: Bearer {{teacherToken}}

### Get Students - Error: No Token
GET {{baseUrl}}/api/students

### Create Student - Error: Invalid Token
POST {{baseUrl}}/api/students
Authorization: Bearer invalid-token-here
Content-Type: application/json

{
  "cpr": "123456789",
  "firstName": "Test",
  "dateOfBirth": "2010-01-01",
  "gender": "Male"
}

# ==================== NOTES ====================
# 
# Total Endpoints: 8
# - POST /api/students (Create)
# - GET /api/students (Get all with filters)
# - GET /api/students/:id (Get by ID)
# - GET /api/students/search (Search)
# - PUT /api/students/:id (Update)
# - DELETE /api/students/:id (Soft delete)
# - POST /api/students/:id/phones (Add phone)
# - POST /api/students/:id/parents (Link parent)
#
# Access Control:
# - Admin: Full access (all operations)
# - Teacher: Read-only access (view students)
# - Student/Parent: No direct access
#
# Features:
# - Full CRUD operations
# - Search by name, CPR, email
# - Multiple filters (gender, school, center, etc.)
# - Pagination support
# - Soft delete (deactivation)
# - Phone number management
# - Parent-student linking
# - Shared email support (Parent-Student)
# - Transaction-based updates
#
